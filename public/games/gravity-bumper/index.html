<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gravity Bumper</title>
    <style>
        :root {
            --bg-color: #050505;
            --ui-bg: #141414;
            --neon-cyan: #00ffff;
            --neon-magenta: #ff00ff;
            --neon-lime: #00ff00;
            --neon-yellow: #ffff00;
            --text-color: #ffffff;
            --font-main: 'Segoe UI', sans-serif;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
            touch-action: none;
        }

        /* --- New Layout: Header / Main / Footer --- */

        .header {
            flex: 0 0 auto;
            background: var(--ui-bg);
            border-bottom: 2px solid var(--neon-cyan);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        #game-container {
            flex: 1 1 auto;
            position: relative;
            overflow: hidden;
            background: #111;
            /* Canvas will resize to fill this */
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .footer {
            flex: 0 0 auto;
            background: var(--ui-bg);
            border-top: 2px solid var(--neon-magenta);
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            min-height: 100px;
        }

        /* --- Header UI --- */
        .stage-info {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--neon-cyan);
            text-shadow: 0 0 5px var(--neon-cyan);
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        button {
            background: #333;
            color: #fff;
            border: 2px solid #555;
            padding: 8px 16px;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            transition: all 0.2s;
        }

        button:hover {
            background: #444;
            border-color: #777;
        }

        button:active {
            transform: scale(0.95);
        }

        button.primary {
            border-color: var(--neon-lime);
            color: var(--neon-lime);
        }

        button.primary:hover {
            background: rgba(0, 255, 0, 0.1);
            box-shadow: 0 0 10px var(--neon-lime);
        }

        button.danger {
            border-color: var(--neon-magenta);
            color: var(--neon-magenta);
        }

        button.danger:hover {
            background: rgba(255, 0, 255, 0.1);
            box-shadow: 0 0 10px var(--neon-magenta);
        }

        button.info {
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
        }

        /* --- Footer (Inventory) UI --- */
        #inventory-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 5px;
        }

        .inventory-item {
            width: 60px;
            height: 60px;
            border: 2px solid #555;
            background: #222;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: grab;
            border-radius: 8px;
            transition: transform 0.1s;
        }

        .inventory-item:active {
            cursor: grabbing;
        }

        .inventory-item.disabled {
            opacity: 0.3;
            pointer-events: none;
            filter: grayscale(100%);
        }

        .inventory-item .count {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: var(--neon-cyan);
            color: #000;
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }

        .inventory-item .icon {
            width: 40px;
            text-align: center;
        }

        /* --- Icons (CSS Shapes) --- */
        .icon.bumper {
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, var(--neon-magenta) 30%, transparent 40%);
            border: 2px solid var(--neon-magenta);
            border-radius: 5px;
        }

        .icon.booster {
            width: 40px;
            height: 40px;
            clip-path: polygon(20% 0%, 80% 0%, 100% 100%, 0% 100%);
            background: linear-gradient(to top, var(--neon-cyan), transparent);
            border-bottom: 3px solid var(--neon-cyan);
        }

        /* --- In-Game Overlay --- */
        #phase-shift-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 0, 0.1);
            border: 3px solid var(--neon-yellow);
            color: var(--neon-yellow);
            display: none;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 0.9rem;
            pointer-events: auto;
            cursor: pointer;
            box-shadow: 0 0 15px var(--neon-yellow);
            animation: pulse 2s infinite;
            z-index: 5;
        }

        #phase-shift-btn:active {
            background: rgba(255, 255, 0, 0.5);
            transform: scale(0.95);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 10px var(--neon-yellow);
            }

            50% {
                box-shadow: 0 0 25px var(--neon-yellow);
            }

            100% {
                box-shadow: 0 0 10px var(--neon-yellow);
            }
        }

        /* --- Modals / Screens --- */
        .screen-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.3s;
        }

        .screen-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .modal-content {
            background: #222;
            border: 2px solid var(--neon-cyan);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #fff;
        }

        .modal-message {
            margin-bottom: 30px;
            color: #ccc;
        }

        /* Stage Select Grid */
        .stage-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stage-btn {
            width: 60px;
            height: 60px;
            border: 2px solid var(--neon-cyan);
            color: var(--neon-cyan);
            background: transparent;
            font-size: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .stage-btn:hover {
            background: rgba(0, 255, 255, 0.2);
        }

        .stage-btn.locked {
            border-color: #555;
            color: #555;
            pointer-events: none;
        }
    </style>
</head>

<body>

    <!-- Home Button -->
    <a href="/"
        style="position: fixed; top: 10px; left: 10px; z-index: 1000; padding: 10px 15px; background: rgba(0,0,0,0.7); color: white; border-radius: 8px; text-decoration: none; font-family: sans-serif; font-weight: bold; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(4px);">ğŸ 
        Home</a>

    <!-- Header -->
    <div class="header">
        <div class="controls">
            <button id="btn-back-menu" class="info">â‰¡ ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
        </div>
        <div class="stage-info">Stage <span id="stage-num">1</span>: <span id="stage-name">-</span></div>
        <div class="controls">
            <button id="btn-reset" class="danger">âš  ãƒªã‚»ãƒƒãƒˆ</button>
            <button id="btn-play" class="primary">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>
    </div>

    <!-- Main Game Area -->
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <!-- Overlays inside Game Container -->
        <div id="phase-shift-btn">ãƒ•ã‚§ãƒ¼ã‚º<br>ã‚·ãƒ•ãƒˆ</div>

        <!-- Stage Select Screen -->
        <div class="screen-overlay" id="screen-select">
            <div class="modal-content">
                <h1 style="color: var(--neon-cyan); margin-top:0;">GRAVITY BUMPER</h1>
                <p>ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                <div class="stage-grid" id="stage-grid">
                    <!-- JS Injected -->
                </div>
            </div>
        </div>

        <!-- Result Modal -->
        <div class="screen-overlay hidden" id="modal-result">
            <div class="modal-content">
                <h1 class="modal-title" id="modal-title">ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼</h1>
                <p class="modal-message" id="modal-msg">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
                <div id="modal-actions">
                    <button id="btn-next" class="primary">æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸</button>
                    <button id="btn-retry" class="danger">ã‚‚ã†ä¸€åº¦</button>
                    <button id="btn-menu-res" class="info">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div id="inventory-bar">
            <!-- JS Injected -->
        </div>
        <div class="inventory-hint" style="color:#888; font-size: 0.8rem;">
            ãƒ‘ãƒ¼ãƒ„ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é…ç½® / <span style="color: var(--neon-cyan);">é…ç½®æ¸ˆã¿ãƒ‘ãƒ¼ãƒ„ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§å›è»¢</span>
        </div>
    </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        /**
         * Gravity Bumper
         * ç‰©ç†æ¼”ç®—ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ 
         */

        // --- UTILITIES ---
        class Vec2 {
            constructor(x, y) { this.x = x; this.y = y; }
            add(v) { return new Vec2(this.x + v.x, this.y + v.y); }
            sub(v) { return new Vec2(this.x - v.x, this.y - v.y); }
            mult(s) { return new Vec2(this.x * s, this.y * s); }
            div(s) { return new Vec2(this.x / s, this.y / s); }
            mag() { return Math.sqrt(this.x * this.x + this.y * this.y); }
            normalize() {
                const m = this.mag();
                return m === 0 ? new Vec2(0, 0) : this.div(m);
            }
            dot(v) { return this.x * v.x + this.y * v.y; }
            dist(v) { return this.sub(v).mag(); }
            rotate(angle) {
                const cos = Math.cos(angle);
                const sin = Math.sin(angle);
                return new Vec2(
                    this.x * cos - this.y * sin,
                    this.x * sin + this.y * cos
                );
            }
            copy() { return new Vec2(this.x, this.y); }
        }

        // --- GAME CONSTANTS ---
        const CONSTANTS = {
            GRAVITY: new Vec2(0, 500),
            FRICTION_AIR: 0.999, // æ‘©æ“¦å¤§å¹…ä½æ¸›
            FRICTION_WALL: 0.9, // å£æ‘©æ“¦ä½æ¸›
            RESTITUTION_WALL: 0.6, // åç™ºå°‘ã—ã‚¢ãƒƒãƒ—
            RESTITUTION_BUMPER: 1.5,
            BOOST_SPEED: 800,
            GRID_SIZE: 40,
            BALL_RADIUS: 12
        };

        /**
         * å…¥åŠ›ç®¡ç†ã‚¯ãƒ©ã‚¹
         * ãƒã‚¦ã‚¹ã¨ã‚¿ãƒƒãƒæ“ä½œã‚’çµ±ä¸€ã—ã¦æ‰±ã†
         */
        class InputHandler {
            constructor(canvas) {
                this.canvas = canvas;
                this.pos = new Vec2(0, 0);
                this.isDown = false;
                this.isDragging = false;

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
                canvas.addEventListener('mousedown', e => this.onDown(e));
                window.addEventListener('mousemove', e => this.onMove(e));
                window.addEventListener('mouseup', e => this.onUp(e));

                canvas.addEventListener('touchstart', e => this.onDown(e), { passive: false });
                window.addEventListener('touchmove', e => this.onMove(e), { passive: false });
                window.addEventListener('touchend', e => this.onUp(e));

                // ç‰¹å®šã®UIè¦ç´ ç”¨ (Phase Shiftãƒœã‚¿ãƒ³ãªã©)
                this.externalButtons = {};
            }

            getCanvasPos(e) {
                const rect = this.canvas.getBoundingClientRect();
                let clientX, clientY;
                if (e.changedTouches && e.changedTouches.length > 0) {
                    clientX = e.changedTouches[0].clientX;
                    clientY = e.changedTouches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
                const scaleX = this.canvas.width / rect.width;
                const scaleY = this.canvas.height / rect.height;
                return new Vec2((clientX - rect.left) * scaleX, (clientY - rect.top) * scaleY);
            }

            onDown(e) {
                if (e.cancelable) e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
                this.isDown = true;
                this.pos = this.getCanvasPos(e);
            }

            onMove(e) {
                if (e.cancelable) e.preventDefault();
                this.pos = this.getCanvasPos(e);
                if (this.isDown) {
                    this.isDragging = true;
                }
            }

            onUp(e) {
                this.isDown = false;
                this.isDragging = false;
            }
        }

        /**
         * ã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåŸºåº•ã‚¯ãƒ©ã‚¹
         */
        class Entity {
            constructor(type, x, y, width, height, angle = 0) {
                this.type = type; // 'ball', 'wall', 'bumper', 'booster', 'gate', 'goal'
                this.pos = new Vec2(x, y);
                this.width = width;
                this.height = height;
                this.angle = angle; // ãƒ©ã‚¸ã‚¢ãƒ³
                this.color = '#fff';
                this.isStatic = true;
                this.toDelete = false;
            }

            // çŸ©å½¢ã®é ‚ç‚¹ã‚’å–å¾— (å›è»¢å¯¾å¿œ)
            getVertices() {
                const hw = this.width / 2;
                const hh = this.height / 2;
                // ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ã§ã®é ‚ç‚¹
                const corners = [
                    new Vec2(-hw, -hh), new Vec2(hw, -hh),
                    new Vec2(hw, hh), new Vec2(-hw, hh)
                ];
                // å›è»¢ã¨å¹³è¡Œç§»å‹•
                return corners.map(p => p.rotate(this.angle).add(this.pos));
            }
        }

        class Ball extends Entity {
            constructor(x, y) {
                super('ball', x, y, CONSTANTS.BALL_RADIUS * 2, CONSTANTS.BALL_RADIUS * 2);
                this.radius = CONSTANTS.BALL_RADIUS;
                this.vel = new Vec2(0, 0);
                this.isStatic = false;
                this.color = '#ffffff';
            }
        }

        /**
         * ç‰©ç†æ¼”ç®—ã‚¨ãƒ³ã‚¸ãƒ³
         */
        class PhysicsEngine {
            constructor() {
                this.entities = [];
            }

            add(entity) {
                this.entities.push(entity);
            }

            clear() {
                this.entities = [];
            }

            update(dt) {
                // é‡åŠ›äº•æˆ¸ãƒªã‚¹ãƒˆå–å¾—
                const wells = this.entities.filter(e => e.type === 'gravity_well');

                // ã‚¹ãƒ†ãƒƒãƒ—æ›´æ–° (ç°¡æ˜“çš„ãªã‚ªã‚¤ãƒ©ãƒ¼æ³•)
                this.entities.forEach(e => {
                    if (!e.isStatic && e.type === 'ball') {
                        // é‡åŠ›
                        e.vel = e.vel.add(CONSTANTS.GRAVITY.mult(dt));

                        // Gravity Wells Attraction
                        wells.forEach(well => {
                            const dir = well.pos.sub(e.pos);
                            const distSq = dir.magSq();
                            // æœ€å°è·é›¢åˆ¶é™ï¼ˆç‰¹ç•°ç‚¹å›é¿ï¼‰ã¨æœ€å¤§å½±éŸ¿ç¯„å›²
                            // åŠå¾„ã®2å€ãã‚‰ã„ã¾ã§å½±éŸ¿
                            const range = well.width * 2;
                            if (distSq < range * range) {
                                const dist = Math.sqrt(distSq);
                                const forceMag = 2000000 / (distSq + 1000); // èª¿æ•´ä¿‚æ•°
                                const force = dir.normalize().mult(forceMag);
                                e.vel = e.vel.add(force.mult(dt));
                            }
                        });

                        // ç©ºæ°—æŠµæŠ—
                        e.vel = e.vel.mult(CONSTANTS.FRICTION_AIR);
                        // ä½ç½®æ›´æ–°
                        e.pos = e.pos.add(e.vel.mult(dt));
                    }
                });

                // è¡çªåˆ¤å®šã¨è§£æ±º
                this.checkCollisions();
            }

            checkCollisions() {
                const balls = this.entities.filter(e => e.type === 'ball');
                const obstacles = this.entities.filter(e => e.type !== 'ball' && e.type !== 'start'); // startã¯å½“ãŸã‚Šåˆ¤å®šãªã—

                balls.forEach(ball => {
                    obstacles.forEach(obs => {
                        // ã‚²ãƒ¼ãƒˆ: OFFãªã‚‰å½“ãŸã‚Šåˆ¤å®šãªã—
                        if (obs.type === 'gate' && !obs.isActive) return;

                        // ã‚´ãƒ¼ãƒ«åˆ¤å®šã¯ç‰©ç†åå°„ã—ãªã„ (GameManagerã§å‡¦ç†ã™ã‚‹ãŒã€ã“ã“ã¯ç‰©ç†çš„ãªæ¥è§¦ã®ã¿è¦‹ã‚‹)
                        // ãŸã ã—ã‚´ãƒ¼ãƒ«ã¯é ˜åŸŸä¾µå…¥æ¤œçŸ¥ã ã‘ãªã®ã§ç‰©ç†åå°„ã¯ã•ã›ãªã„
                        if (obs.type === 'goal' || obs.type === 'gravity_well') return;

                        this.resolveCollision(ball, obs);
                    });

                    // ç”»é¢ç«¯ã®å‡¦ç† (ç°¡æ˜“: è½ã¡ãŸã‚‰ãƒªã‚»ãƒƒãƒˆã ãŒã€å£ã¨ã—ã¦ã®ç”»é¢ç«¯ã¯è¨­ã‘ãªã„)
                    // ã‚¹ãƒ†ãƒ¼ã‚¸å¤–åˆ¤å®šã¯GameManagerã§è¡Œã†
                });
            }

            // å††(Ball) vs çŸ©å½¢(Rotated Rect)
            resolveCollision(ball, rect) {
                // 1. å††ã®ä¸­å¿ƒã‚’çŸ©å½¢ã®ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ç³»ã«å¤‰æ›
                // çŸ©å½¢ã®ä¸­å¿ƒã‚’åŸç‚¹ãƒªã‚»ãƒƒãƒˆ -> é€†å›è»¢
                const relPos = ball.pos.sub(rect.pos).rotate(-rect.angle);

                // 2. ã‚¯ãƒ©ãƒ³ãƒ—å‡¦ç† (AABBå†…ã®ä¸€ç•ªè¿‘ã„ç‚¹ã‚’è¦‹ã¤ã‘ã‚‹)
                const halfW = rect.width / 2;
                const halfH = rect.height / 2;
                const closestX = Math.max(-halfW, Math.min(halfW, relPos.x));
                const closestY = Math.max(-halfH, Math.min(halfH, relPos.y));

                // 3. è·é›¢ãƒã‚§ãƒƒã‚¯
                const distVec = new Vec2(relPos.x - closestX, relPos.y - closestY);
                let dist = distVec.mag();

                // å†…éƒ¨ã«ã„ã‚‹å ´åˆ (dist == 0)ã€ã‚ã‚‹ã„ã¯åŠå¾„ã‚ˆã‚Šå°ã•ã„å ´åˆè¡çª
                if (dist > ball.radius) return; // è¡çªãªã—

                // 4. æ³•ç·šãƒ™ã‚¯ãƒˆãƒ«ã®è¨ˆç®— (ãƒ­ãƒ¼ã‚«ãƒ«ç©ºé–“)
                let normal;
                if (dist === 0) {
                    // ä¸­å¿ƒã¨ä¸€è‡´ã¾ãŸã¯å†…éƒ¨: å¤–å´ã¸æŠ¼ã—å‡ºã™æ³•ç·šã‚’é¸ã¶ï¼ˆç°¡æ˜“çš„ã«Yè»¸ãªã©ï¼‰
                    // ã“ã“ã§ã¯å˜ç´”ã«é€Ÿåº¦ã®é€†æ–¹å‘ãªã©ã‚’æ¡ç”¨ã—ãŸã„ãŒã€
                    // çŸ©å½¢ä¸­å¿ƒã‹ã‚‰å††ä¸­å¿ƒã¸ã®ãƒ™ã‚¯ãƒˆãƒ«ã‚’æ¡ç”¨
                    normal = relPos.normalize();
                    dist = 0.1; // é‡ãªã‚Šå›é¿ç”¨å¾®å°å€¤
                } else {
                    normal = distVec.normalize();
                }

                // 5. ãƒ¯ãƒ¼ãƒ«ãƒ‰ç©ºé–“ã«æˆ»ã™
                normal = normal.rotate(rect.angle);
                const penetration = ball.radius - dist;

                // ä½ç½®è£œæ­£ (ã‚ã‚Šè¾¼ã¿è§£æ¶ˆ)
                ball.pos = ball.pos.add(normal.mult(penetration));

                // 6. é€Ÿåº¦ã®åå°„
                // ç›¸å¯¾é€Ÿåº¦ (é™æ­¢å£ãªã®ã§ãƒœãƒ¼ãƒ«é€Ÿåº¦ãã®ã¾ã¾, å‹•ãå£ãªã‚‰ v - wall_v)
                const vDotN = ball.vel.dot(normal);

                if (vDotN < 0) { // è¿‘ã¥ã„ã¦ã„ã‚‹å ´åˆã®ã¿åå°„
                    let restitution = CONSTANTS.RESTITUTION_WALL;

                    // ã‚¿ã‚¤ãƒ—åˆ¥ã®æŒ™å‹•
                    if (rect.type === 'bumper') {
                        restitution = CONSTANTS.RESTITUTION_BUMPER;
                    } else if (rect.type === 'booster') {
                        // ãƒ–ãƒ¼ã‚¹ã‚¿ãƒ¼: é€²è¡Œæ–¹å‘(çŸ©å½¢ã®ãƒ­ãƒ¼ã‚«ãƒ«Xã¾ãŸã¯Y)ã¸ã®åŠ é€Ÿ
                        // ãƒ–ãƒ¼ã‚¹ã‚¿ãƒ¼ã®å‘ã: rect.angle ãŒå‘ã„ã¦ã„ã‚‹æ–¹å‘ã¨ä»®å®š
                        const boostDir = new Vec2(Math.cos(rect.angle), Math.sin(rect.angle));
                        // é€Ÿåº¦ã‚’ãƒ–ãƒ¼ã‚¹ãƒˆæ–¹å‘ã«å¼·åˆ¶ï¼‹åŠ é€Ÿ
                        ball.vel = boostDir.mult(CONSTANTS.BOOST_SPEED);
                        return; // é€šå¸¸åå°„ã¯ã—ãªã„
                    }

                    // åå°„ãƒ™ã‚¯ãƒˆãƒ«: V_new = V - (1+e) * (V.N) * N
                    const j = -(1 + restitution) * vDotN;
                    const impulse = normal.mult(j);
                    ball.vel = ball.vel.add(impulse);

                    // ç°¡æ˜“æ‘©æ“¦ (æ¥ç·šæ–¹å‘ã®æ¸›è¡°)
                    const tangent = ball.vel.sub(normal.mult(ball.vel.dot(normal))).normalize();
                    const friction = CONSTANTS.FRICTION_WALL;
                    // æ¥ç·šæˆåˆ†ã‚’æ¸›è¡°
                    const tComponent = ball.vel.dot(tangent);
                    ball.vel = ball.vel.sub(tangent.mult(tComponent * (1 - friction)));
                }
            }
        }

        /**
         * æç”»ã‚¯ãƒ©ã‚¹
         */
        class Renderer {
            constructor(canvas, ctx) {
                this.canvas = canvas;
                this.ctx = ctx;
            }

            clear() {
                this.ctx.fillStyle = '#111';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            }

            drawGrid() {
                this.ctx.strokeStyle = '#222';
                this.ctx.lineWidth = 1;
                const sz = CONSTANTS.GRID_SIZE;
                for (let x = 0; x < this.canvas.width; x += sz) {
                    this.ctx.beginPath(); this.ctx.moveTo(x, 0); this.ctx.lineTo(x, this.canvas.height); this.ctx.stroke();
                }
                for (let y = 0; y < this.canvas.height; y += sz) {
                    this.ctx.beginPath(); this.ctx.moveTo(0, y); this.ctx.lineTo(this.canvas.width, y); this.ctx.stroke();
                }
            }

            drawEntity(e) {
                this.ctx.save();
                this.ctx.translate(e.pos.x, e.pos.y);
                this.ctx.rotate(e.angle);

                // å½±ã¨ç™ºå…‰
                this.ctx.shadowBlur = 10;
                this.ctx.shadowColor = e.color;

                if (e.type === 'ball') {
                    this.ctx.fillStyle = e.color;
                    this.ctx.beginPath();
                    this.ctx.arc(0, 0, e.width / 2, 0, Math.PI * 2);
                    this.ctx.fill();
                } else if (e.type === 'wall') {
                    this.ctx.fillStyle = '#333';
                    this.ctx.strokeStyle = '#777';
                    this.ctx.lineWidth = 2;
                    this.ctx.fillRect(-e.width / 2, -e.height / 2, e.width, e.height);
                    this.ctx.strokeRect(-e.width / 2, -e.height / 2, e.width, e.height);
                } else if (e.type === 'bumper') {
                    this.ctx.fillStyle = '#440044';
                    this.ctx.strokeStyle = '#ff00ff';
                    this.ctx.lineWidth = 3;
                    // è§’ä¸¸çŸ©å½¢é¢¨
                    this.ctx.beginPath();
                    this.ctx.roundRect(-e.width / 2, -e.height / 2, e.width, e.height, 10);
                    this.ctx.fill();
                    this.ctx.stroke();
                    // å†…éƒ¨è£…é£¾
                    this.ctx.beginPath();
                    this.ctx.arc(0, 0, e.width / 4, 0, Math.PI * 2);
                    this.ctx.fillStyle = '#ff00ff';
                    this.ctx.fill();
                } else if (e.type === 'booster') {
                    this.ctx.fillStyle = '#002222';
                    this.ctx.strokeStyle = '#00ffff';
                    this.ctx.lineWidth = 2;
                    this.ctx.beginPath();
                    this.ctx.moveTo(-e.width / 2, -e.height / 2);
                    this.ctx.lineTo(e.width / 2, 0);
                    this.ctx.lineTo(-e.width / 2, e.height / 2);
                    this.ctx.closePath();
                    this.ctx.fill();
                    this.ctx.stroke();
                    // åŠ é€ŸçŸ¢å°
                    this.ctx.fillStyle = '#00ffff';
                    this.ctx.font = '20px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText('>>>', -5, 1);
                } else if (e.type === 'gate') {
                    if (e.isActive) {
                        this.ctx.strokeStyle = '#0088ff'; // Blue for Phase Shift
                        this.ctx.lineWidth = 4;
                        // Solid line
                        this.ctx.beginPath();
                        this.ctx.moveTo(-e.width / 2, 0);
                        this.ctx.lineTo(e.width / 2, 0);
                        this.ctx.stroke();

                        // Glow effect
                        this.ctx.shadowColor = '#0088ff';
                        this.ctx.shadowBlur = 10;
                    } else {
                        // Inactive (Ghost)
                        this.ctx.strokeStyle = 'rgba(0, 136, 255, 0.2)';
                        this.ctx.setLineDash([5, 5]);
                        this.ctx.lineWidth = 2;
                        this.ctx.beginPath();
                        this.ctx.moveTo(-e.width / 2, 0);
                        this.ctx.lineTo(e.width / 2, 0);
                        this.ctx.stroke();
                        this.ctx.setLineDash([]);
                        this.ctx.shadowBlur = 0;
                    }
                } else if (e.type === 'gravity_well') {
                    // Gravity Well Visuals
                    this.ctx.fillStyle = 'rgba(138, 43, 226, 0.1)'; // Purple area
                    this.ctx.beginPath();
                    this.ctx.arc(0, 0, e.width / 2, 0, Math.PI * 2);
                    this.ctx.fill();

                    // Swirl effect (static for now)
                    this.ctx.strokeStyle = '#8a2be2';
                    this.ctx.lineWidth = 2;
                    this.ctx.beginPath();
                    // Draw a few concentric/spiral rings
                    for (let r = 10; r < e.width / 2; r += 10) {
                        this.ctx.moveTo(r, 0);
                        this.ctx.arc(0, 0, r, 0, Math.PI * 2);
                    }
                    this.ctx.stroke();

                    this.ctx.fillStyle = '#fff';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText('WELL', 0, 0);
                } else if (e.type === 'goal') {
                    this.ctx.fillStyle = 'rgba(255, 255, 0, 0.2)';
                    this.ctx.strokeStyle = 'yellow';
                    this.ctx.lineWidth = 2;
                    this.ctx.setLineDash([10, 5]);
                    this.ctx.strokeRect(-e.width / 2, -e.height / 2, e.width, e.height);
                    this.ctx.fillRect(-e.width / 2, -e.height / 2, e.width, e.height);
                    this.ctx.setLineDash([]);
                    this.ctx.fillStyle = '#ffff00';
                    this.ctx.font = 'bold 16px Arial';
                    this.ctx.fillText('GOAL', 0, 0);
                } else if (e.type === 'start') {
                    this.ctx.strokeStyle = '#fff';
                    this.ctx.setLineDash([4, 4]);
                    this.ctx.strokeRect(-e.width / 2, -e.height / 2, e.width, e.height);
                    this.ctx.setLineDash([]);
                    this.ctx.fillStyle = '#aaa';
                    this.ctx.fillText('START', 0, 0);
                }

                this.ctx.restore();
            }
        }

        // --- ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ (å…¨10ã‚¹ãƒ†ãƒ¼ã‚¸) ---
        const STAGES = [
            // 1. Phase Shift Intro (Old 3)
            {
                id: 1, name: "ãƒ•ã‚§ãƒ¼ã‚ºã‚·ãƒ•ãƒˆå…¥é–€",
                inventory: { bumper: 4, booster: 1 },
                gimmick: { phase: true },
                startZone: { x: 50, y: 50, w: 150, h: 150 },
                entities: [
                    { type: 'start', x: 100, y: 100, w: 60, h: 60, angle: 0 },
                    { type: 'goal', x: 700, y: 500, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 400, y: 580, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 20, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 780, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'gate', isActive: true, x: 400, y: 300, w: 600, h: 20, angle: 0 }
                ]
            },
            // 2. Limited Resources (Old 1)
            {
                id: 2, name: "é™ã‚‰ã‚ŒãŸè³‡æº",
                inventory: { bumper: 3, booster: 0 },
                gimmick: { phase: false },
                startZone: { x: 50, y: 50, w: 150, h: 150 },
                entities: [
                    { type: 'start', x: 100, y: 100, w: 60, h: 60, angle: 0 },
                    { type: 'goal', x: 700, y: 500, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 400, y: 20, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 400, y: 580, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 20, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 780, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 400, y: 300, w: 20, h: 300, angle: 0 },
                    { type: 'wall', x: 200, y: 400, w: 200, h: 20, angle: 0.2 },
                    // éšœå®³ç‰©ã‚’è¿½åŠ ã—ã¦ç›´ç·šã‚¯ãƒªã‚¢ã‚’é˜²æ­¢
                    { type: 'wall', x: 600, y: 400, w: 200, h: 20, angle: -0.2 }
                ]
            },
            // 3. Momentum (Old 2)
            {
                id: 3, name: "ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ ",
                inventory: { bumper: 2, booster: 2 },
                gimmick: { phase: false },
                startZone: { x: 30, y: 450, w: 100, h: 100 },
                entities: [
                    { type: 'start', x: 80, y: 500, w: 60, h: 60, angle: 0 },
                    { type: 'goal', x: 700, y: 100, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 400, y: 580, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 20, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 780, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 200, y: 450, w: 300, h: 20, angle: -0.3 },
                    { type: 'wall', x: 500, y: 300, w: 200, h: 20, angle: 0 },
                    { type: 'wall', x: 700, y: 200, w: 20, h: 200, angle: 0 }
                ]
            },
            // 4. Double Gate
            {
                id: 4, name: "ãƒ€ãƒ–ãƒ«ã‚²ãƒ¼ãƒˆ",
                inventory: { bumper: 3, booster: 1 },
                gimmick: { phase: true },
                startZone: { x: 50, y: 50, w: 100, h: 100 },
                entities: [
                    { type: 'start', x: 80, y: 80, w: 60, h: 60, angle: 0 },
                    { type: 'goal', x: 700, y: 500, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 400, y: 580, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 20, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 780, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'gate', isActive: true, x: 200, y: 200, w: 20, h: 400, angle: 0 },
                    { type: 'wall', x: 500, y: 350, w: 200, h: 20, angle: 0.1 },
                    { type: 'gate', isActive: true, x: 600, y: 450, w: 20, h: 200, angle: 0 }
                ]
            },
            // 5. Phase Drop
            {
                id: 5, name: "ãƒ•ã‚§ãƒ¼ã‚ºãƒ»ãƒ‰ãƒ­ãƒƒãƒ—",
                inventory: { bumper: 5, booster: 2 },
                gimmick: { phase: true },
                startZone: { x: 300, y: 50, w: 200, h: 100 },
                entities: [
                    { type: 'start', x: 400, y: 100, w: 60, h: 60, angle: 0 },
                    { type: 'goal', x: 400, y: 500, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 20, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 780, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 400, y: 580, w: 800, h: 40, angle: 0 },
                    { type: 'gate', isActive: true, x: 400, y: 200, w: 600, h: 20, angle: 0 },
                    { type: 'wall', x: 400, y: 300, w: 200, h: 20, angle: 0 }, // Blocking direct drop
                    { type: 'gate', isActive: true, x: 400, y: 400, w: 600, h: 20, angle: 0 },
                    { type: 'wall', x: 200, y: 300, w: 20, h: 100, angle: 0 },
                    { type: 'wall', x: 600, y: 300, w: 20, h: 100, angle: 0 }
                ]
            },
            // 6. Pinball (Hard)
            {
                id: 6, name: "ãƒ”ãƒ³ãƒœãƒ¼ãƒ«é…ç½®",
                inventory: { bumper: 2, booster: 0 },
                gimmick: { phase: false },
                startZone: { x: 50, y: 500, w: 100, h: 100 },
                entities: [
                    { type: 'start', x: 100, y: 530, w: 60, h: 60, angle: 0 },
                    { type: 'goal', x: 700, y: 530, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 400, y: 580, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 20, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 780, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 400, y: 20, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 300, y: 200, w: 20, h: 200, angle: 0.5 },
                    { type: 'wall', x: 500, y: 200, w: 20, h: 200, angle: -0.5 },
                    { type: 'wall', x: 400, y: 400, w: 100, h: 20, angle: 0 }
                ]
            },
            // 7. Narrow Gate
            {
                id: 7, name: "ç‹­ãé–€",
                inventory: { bumper: 1, booster: 1 },
                gimmick: { phase: false },
                startZone: { x: 50, y: 50, w: 100, h: 100 },
                entities: [
                    { type: 'start', x: 80, y: 80, w: 60, h: 60, angle: 0 },
                    { type: 'goal', x: 700, y: 500, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 400, y: 580, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 20, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 780, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 300, y: 300, w: 20, h: 400, angle: 0 },
                    { type: 'wall', x: 360, y: 300, w: 20, h: 400, angle: 0 },
                    { type: 'wall', x: 600, y: 200, w: 200, h: 20, angle: 0.2 },
                    { type: 'wall', x: 450, y: 150, w: 20, h: 200, angle: 0 }, // Blocking direct line
                ]
            },
            // 8. Loop Boost
            {
                id: 8, name: "ãƒ«ãƒ¼ãƒ—ãƒ»ãƒ–ãƒ¼ã‚¹ãƒˆ",
                inventory: { bumper: 2, booster: 3 },
                gimmick: { phase: false },
                startZone: { x: 50, y: 300, w: 100, h: 100 },
                entities: [
                    { type: 'start', x: 100, y: 350, w: 60, h: 60, angle: 0 },
                    { type: 'goal', x: 100, y: 150, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 400, y: 580, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 20, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 780, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 400, y: 20, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 200, y: 450, w: 250, h: 20, angle: -0.1 },
                    { type: 'wall', x: 600, y: 300, w: 20, h: 300, angle: 0 },
                    { type: 'wall', x: 400, y: 200, w: 300, h: 20, angle: 0.1 },
                    { type: 'wall', x: 100, y: 250, w: 100, h: 20, angle: 0 } // Blocking direct up
                ]
            },
            // 9. Sky High
            {
                id: 9, name: "ã‚¹ã‚«ã‚¤ãƒã‚¤",
                inventory: { bumper: 3, booster: 4 },
                gimmick: { phase: false },
                startZone: { x: 50, y: 500, w: 100, h: 100 },
                entities: [
                    { type: 'start', x: 100, y: 550, w: 60, h: 60, angle: 0 },
                    { type: 'goal', x: 700, y: 50, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 400, y: 580, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 20, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 780, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 200, y: 400, w: 100, h: 20, angle: 0 },
                    { type: 'wall', x: 400, y: 300, w: 100, h: 20, angle: 0 },
                    { type: 'wall', x: 600, y: 200, w: 100, h: 20, angle: 0 }
                ]
            },
            // 10. Grand Finale
            {
                id: 10, name: "ã‚°ãƒ©ãƒ³ãƒ‰ãƒ»ãƒ•ã‚£ãƒŠãƒ¼ãƒ¬",
                inventory: { bumper: 5, booster: 3 },
                gimmick: { phase: true },
                startZone: { x: 400, y: 500, w: 100, h: 100 },
                entities: [
                    { type: 'start', x: 400, y: 530, w: 60, h: 60, angle: 0 },
                    { type: 'goal', x: 400, y: 80, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 400, y: 580, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 20, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 780, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 400, y: 20, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 200, y: 400, w: 200, h: 20, angle: -0.4 },
                    { type: 'wall', x: 600, y: 400, w: 200, h: 20, angle: 0.4 },
                    { type: 'gate', isActive: true, x: 400, y: 300, w: 200, h: 20, angle: 0 },
                    { type: 'wall', x: 200, y: 200, w: 20, h: 100, angle: 0 },
                    { type: 'wall', x: 600, y: 200, w: 20, h: 100, angle: 0 },
                    { type: 'wall', x: 400, y: 250, w: 150, h: 20, angle: 0 } // Blocking direct up
                ]
            },
            // 11. Gravity Well Intro
            {
                id: 11, name: "æ·±æ·µã®å…¥ã‚Šå£",
                inventory: { bumper: 3, booster: 1 },
                gimmick: { phase: false },
                startZone: { x: 50, y: 50, w: 200, h: 200 },
                entities: [
                    { type: 'start', x: 100, y: 100, w: 60, h: 60, angle: 0 },
                    { type: 'goal', x: 700, y: 200, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 400, y: 20, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 400, y: 580, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 20, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 780, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'gravity_well', x: 400, y: 300, w: 100, h: 100, angle: 0 },
                    { type: 'wall', x: 400, y: 200, w: 20, h: 200, angle: 0 }
                ]
            },
            // 12. Orbital Swing
            {
                id: 12, name: "ã‚ªãƒ¼ãƒ“ã‚¿ãƒ«ãƒ»ã‚¹ã‚¤ãƒ³ã‚°",
                inventory: { bumper: 2, booster: 2 },
                gimmick: { phase: false },
                startZone: { x: 50, y: 300, w: 100, h: 100 },
                entities: [
                    { type: 'start', x: 100, y: 300, w: 60, h: 60, angle: 0 },
                    { type: 'goal', x: 100, y: 500, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 400, y: 580, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 20, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 780, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 400, y: 20, w: 800, h: 40, angle: 0 },
                    { type: 'gravity_well', x: 300, y: 200, w: 120, h: 120, angle: 0 },
                    { type: 'gravity_well', x: 500, y: 400, w: 120, h: 120, angle: 0 },
                    { type: 'wall', x: 400, y: 300, w: 20, h: 400, angle: 0.5 }
                ]
            },
            // 13. Black Hole Sun
            {
                id: 13, name: "ãƒ–ãƒ©ãƒƒã‚¯ãƒ›ãƒ¼ãƒ«ãƒ»ã‚µãƒ³",
                inventory: { bumper: 4, booster: 1 },
                gimmick: { phase: false },
                startZone: { x: 700, y: 50, w: 100, h: 100 },
                entities: [
                    { type: 'start', x: 700, y: 100, w: 60, h: 60, angle: 0 },
                    { type: 'goal', x: 100, y: 500, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 400, y: 580, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 20, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 780, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 400, y: 20, w: 800, h: 40, angle: 0 },
                    { type: 'gravity_well', x: 400, y: 300, w: 200, h: 200, angle: 0 },
                    { type: 'wall', x: 200, y: 200, w: 60, h: 20, angle: 0.2 },
                    { type: 'wall', x: 600, y: 400, w: 60, h: 20, angle: -0.2 }
                ]
            },
            // 14. Phase Master
            {
                id: 14, name: "ãƒ•ã‚§ãƒ¼ã‚ºãƒ»ãƒã‚¹ã‚¿ãƒ¼",
                inventory: { bumper: 3, booster: 3 },
                gimmick: { phase: true },
                startZone: { x: 350, y: 50, w: 100, h: 100 },
                entities: [
                    { type: 'start', x: 400, y: 80, w: 60, h: 60, angle: 0 },
                    { type: 'goal', x: 400, y: 500, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 400, y: 580, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 20, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 780, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 400, y: 20, w: 800, h: 40, angle: 0 },
                    { type: 'gate', isActive: true, x: 400, y: 150, w: 400, h: 20, angle: 0 },
                    { type: 'gate', isActive: false, x: 400, y: 250, w: 400, h: 20, angle: 0 },
                    { type: 'gate', isActive: true, x: 400, y: 350, w: 400, h: 20, angle: 0 },
                    { type: 'gate', isActive: false, x: 400, y: 450, w: 400, h: 20, angle: 0 },
                    { type: 'wall', x: 200, y: 300, w: 20, h: 400, angle: 0 },
                    { type: 'wall', x: 600, y: 300, w: 20, h: 400, angle: 0 }
                ]
            },
            // 15. The Trap
            {
                id: 15, name: "ã‚¶ãƒ»ãƒˆãƒ©ãƒƒãƒ—",
                inventory: { bumper: 5, booster: 0 },
                gimmick: { phase: true },
                startZone: { x: 50, y: 250, w: 100, h: 100 },
                entities: [
                    { type: 'start', x: 100, y: 300, w: 60, h: 60, angle: 0 },
                    { type: 'goal', x: 700, y: 300, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 400, y: 580, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 20, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 780, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 400, y: 20, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 700, y: 250, w: 100, h: 20, angle: 0 },
                    { type: 'wall', x: 700, y: 350, w: 100, h: 20, angle: 0 },
                    { type: 'gate', isActive: true, x: 650, y: 300, w: 20, h: 120, angle: 0 }
                ]
            },
            // 16. Gravity & Phase
            {
                id: 16, name: "é‡åŠ›ã¨ä½ç›¸",
                inventory: { bumper: 3, booster: 2 },
                gimmick: { phase: true },
                startZone: { x: 50, y: 50, w: 100, h: 100 },
                entities: [
                    { type: 'start', x: 80, y: 80, w: 60, h: 60, angle: 0 },
                    { type: 'goal', x: 700, y: 500, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 400, y: 580, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 20, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 780, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'gravity_well', x: 400, y: 300, w: 150, h: 150, angle: 0 },
                    { type: 'gate', isActive: true, x: 400, y: 150, w: 400, h: 20, angle: 0 },
                    { type: 'gate', isActive: false, x: 400, y: 450, w: 400, h: 20, angle: 0 }
                ]
            },
            // 17. The Slalom
            {
                id: 17, name: "ã‚¹ãƒ©ãƒ­ãƒ¼ãƒ ",
                inventory: { bumper: 6, booster: 0 },
                gimmick: { phase: false },
                startZone: { x: 400, y: 50, w: 100, h: 50 },
                entities: [
                    { type: 'start', x: 400, y: 60, w: 60, h: 60, angle: 0 },
                    { type: 'goal', x: 400, y: 500, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 400, y: 580, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 20, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 780, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'gravity_well', x: 200, y: 150, w: 80, h: 80, angle: 0 },
                    { type: 'gravity_well', x: 600, y: 250, w: 80, h: 80, angle: 0 },
                    { type: 'gravity_well', x: 200, y: 350, w: 80, h: 80, angle: 0 },
                    { type: 'gravity_well', x: 600, y: 450, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 400, y: 200, w: 20, h: 100, angle: 0 },
                    { type: 'wall', x: 400, y: 400, w: 20, h: 100, angle: 0 },
                ]
            },
            // 18. Split Path
            {
                id: 18, name: "åˆ†å²ç‚¹",
                inventory: { bumper: 3, booster: 2 },
                gimmick: { phase: true },
                startZone: { x: 400, y: 500, w: 100, h: 100 },
                entities: [
                    { type: 'start', x: 400, y: 500, w: 60, h: 60, angle: 0 },
                    { type: 'goal', x: 400, y: 100, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 400, y: 580, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 20, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 780, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 400, y: 20, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 400, y: 300, w: 100, h: 400, angle: 0 },
                    { type: 'gate', isActive: true, x: 250, y: 300, w: 20, h: 100, angle: 0 },
                    { type: 'gate', isActive: false, x: 550, y: 300, w: 20, h: 100, angle: 0 },
                    { type: 'gravity_well', x: 100, y: 300, w: 100, h: 100, angle: 0 },
                    { type: 'gravity_well', x: 700, y: 300, w: 100, h: 100, angle: 0 },
                ]
            },
            // 19. Chaos Theory
            {
                id: 19, name: "ã‚«ã‚ªã‚¹ç†è«–",
                inventory: { bumper: 3, booster: 3 },
                gimmick: { phase: true },
                startZone: { x: 100, y: 500, w: 100, h: 100 },
                entities: [
                    { type: 'start', x: 100, y: 500, w: 60, h: 60, angle: 0 },
                    { type: 'goal', x: 700, y: 100, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 400, y: 580, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 20, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 780, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 400, y: 20, w: 800, h: 40, angle: 0 },
                    { type: 'gravity_well', x: 200, y: 200, w: 100, h: 100, angle: 0 },
                    { type: 'gravity_well', x: 600, y: 400, w: 100, h: 100, angle: 0 },
                    { type: 'gravity_well', x: 400, y: 300, w: 80, h: 80, angle: 0 },
                    { type: 'gate', isActive: true, x: 300, y: 400, w: 20, h: 200, angle: 0 },
                    { type: 'gate', isActive: false, x: 500, y: 200, w: 20, h: 200, angle: 0 }
                ]
            },
            // 20. Event Horizon
            {
                id: 20, name: "ã‚¤ãƒ™ãƒ³ãƒˆãƒ»ãƒ›ãƒ©ã‚¤ã‚ºãƒ³",
                inventory: { bumper: 5, booster: 5 },
                gimmick: { phase: true },
                startZone: { x: 400, y: 500, w: 100, h: 100 },
                entities: [
                    { type: 'start', x: 400, y: 530, w: 60, h: 60, angle: 0 },
                    { type: 'goal', x: 400, y: 80, w: 80, h: 80, angle: 0 },
                    { type: 'wall', x: 400, y: 580, w: 800, h: 40, angle: 0 },
                    { type: 'wall', x: 20, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 780, y: 300, w: 40, h: 600, angle: 0 },
                    { type: 'wall', x: 400, y: 20, w: 800, h: 40, angle: 0 },
                    { type: 'gravity_well', x: 400, y: 300, w: 250, h: 250, angle: 0 },
                    { type: 'gate', isActive: true, x: 400, y: 180, w: 400, h: 10, angle: 0 },
                    { type: 'gate', isActive: false, x: 400, y: 420, w: 400, h: 10, angle: 0 },
                    { type: 'gate', isActive: true, x: 250, y: 300, w: 10, h: 200, angle: 0 },
                    { type: 'gate', isActive: false, x: 550, y: 300, w: 10, h: 200, angle: 0 },
                ]
            }
        ];
        /**
         * ã‚²ãƒ¼ãƒ ç®¡ç†ã‚¯ãƒ©ã‚¹
         */
        class GameManager {
            constructor() {
                this.container = document.getElementById('game-container');
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();

                // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
                this.input = new InputHandler(this.canvas);
                this.physics = new PhysicsEngine();
                this.renderer = new Renderer(this.canvas, this.ctx);

                // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
                this.state = 'SELECT';
                this.currentStageIndex = 0;
                this.stageData = null;
                this.inventory = {};
                this.placedEntities = [];
                this.unlockedStages = 10;

                this.draggingEntity = null;
                this.ghostEntity = null;

                // UIå‚ç…§
                this.ui = {
                    stageNum: document.getElementById('stage-num'),
                    stageName: document.getElementById('stage-name'),
                    inventory: document.getElementById('inventory-bar'),
                    btnPlay: document.getElementById('btn-play'),
                    btnReset: document.getElementById('btn-reset'),
                    phaseBtn: document.getElementById('phase-shift-btn'),

                    // Screens
                    screenSelect: document.getElementById('screen-select'),
                    stageGrid: document.getElementById('stage-grid'),

                    // Modal
                    modal: document.getElementById('modal-result'),
                    modalTitle: document.getElementById('modal-title'),
                    modalMsg: document.getElementById('modal-msg'),
                    btnNext: document.getElementById('btn-next'),
                    btnRetry: document.getElementById('btn-retry'),
                    btnMenuRes: document.getElementById('btn-menu-res'),

                    // Header
                    btnBackMenu: document.getElementById('btn-back-menu')
                };

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‰
                window.addEventListener('resize', () => this.resize());
                this.ui.btnPlay.addEventListener('click', () => this.toggleRun());
                this.ui.btnReset.addEventListener('click', () => this.resetStage());

                this.ui.btnNext.addEventListener('click', () => {
                    this.state = 'EDIT';
                    this.loadStage(this.currentStageIndex + 1);
                });
                this.ui.btnRetry.addEventListener('click', () => this.retryStage());

                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³
                const goMenu = () => {
                    this.state = 'SELECT';
                    this.updateUIState();
                };
                this.ui.btnBackMenu.addEventListener('click', goMenu);
                this.ui.btnMenuRes.addEventListener('click', () => {
                    this.ui.modal.classList.add('hidden');
                    goMenu();
                });

                // Phase Shift ãƒœã‚¿ãƒ³
                const setPhase = (active) => {
                    if (this.state === 'PLAY' && this.stageData && this.stageData.gimmick.phase) {
                        this.physics.entities.forEach(e => {
                            if (e.type === 'gate') e.isActive = !active;
                        });
                    }
                };
                this.ui.phaseBtn.addEventListener('mousedown', () => setPhase(true));
                this.ui.phaseBtn.addEventListener('mouseup', () => setPhase(false));
                this.ui.phaseBtn.addEventListener('touchstart', (e) => { e.preventDefault(); setPhase(true); });
                this.ui.phaseBtn.addEventListener('touchend', (e) => { e.preventDefault(); setPhase(false); });

                // ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—é–‹å§‹
                requestAnimationFrame(t => this.loop(t));

                // åˆæœŸåŒ–
                this.initStageSelect();
                this.updateUIState();
            }

            resize() {
                // ã‚³ãƒ³ãƒ†ãƒŠã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹
                this.canvas.width = this.container.clientWidth;
                this.canvas.height = this.container.clientHeight;
            }

            initStageSelect() {
                this.ui.stageGrid.innerHTML = '';
                STAGES.forEach((stage, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'stage-btn';
                    btn.textContent = stage.id;
                    if (this.unlockedStages < stage.id) btn.classList.add('locked'); // ä»®

                    btn.onclick = () => {
                        this.loadStage(idx);
                        this.state = 'EDIT';
                        this.updateUIState();
                    };
                    this.ui.stageGrid.appendChild(btn);
                });
            }

            updateUIState() {
                // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
                if (this.state === 'SELECT') {
                    this.ui.screenSelect.classList.remove('hidden');
                    this.ui.modal.classList.add('hidden');
                } else {
                    this.ui.screenSelect.classList.add('hidden');
                }
            }

            loadStage(index) {
                if (index >= STAGES.length) index = 0;
                this.currentStageIndex = index;
                this.stageData = STAGES[index];

                // UIæ›´æ–°
                this.ui.stageNum.textContent = this.stageData.id;
                this.ui.stageName.textContent = this.stageData.name;
                this.ui.phaseBtn.style.display = this.stageData.gimmick.phase ? 'flex' : 'none';
                this.ui.modal.classList.add('hidden');

                // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªåˆæœŸåŒ–
                this.inventory = { ...this.stageData.inventory };
                this.updateInventoryUI();

                // ç‰©ç†ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–
                this.physics.clear();

                // å›ºå®šã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£é…ç½®
                this.stageData.entities.forEach(def => {
                    let e = new Entity(def.type, def.x, def.y, def.w, def.h, def.angle);
                    if (def.type === 'gate') e.isActive = def.isActive;
                    this.physics.add(e);
                });

                this.placedEntities = [];
                this.state = 'EDIT';
                this.ui.btnPlay.textContent = 'â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ';
            }

            updateInventoryUI() {
                this.ui.inventory.innerHTML = '';
                // HTMLè¦ç´ ã®é…ç½®ã‚’å†è¨ˆç®—ã•ã›ã‚‹ãŸã‚å°‘ã—å¾…ã¤å¿…è¦ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ãŒã€
                // CSSã®flexboxãªã®ã§å³æ™‚åæ˜ ã•ã‚Œã‚‹ã¯ãšã€‚
                ['bumper', 'booster'].forEach(type => {
                    const count = this.inventory[type];
                    if (count !== undefined) {
                        const div = document.createElement('div');
                        div.className = `inventory-item ${count > 0 ? '' : 'disabled'}`;
                        div.innerHTML = `<div class="icon ${type}"></div><div class="count">${count}</div>`;

                        div.addEventListener('mousedown', (e) => this.startDragFromInventory(e, type));
                        div.addEventListener('touchstart', (e) => this.startDragFromInventory(e, type), { passive: false });

                        this.ui.inventory.appendChild(div);
                    }
                });
            }

            startDragFromInventory(e, type) {
                if (this.state !== 'EDIT' || this.inventory[type] <= 0) return;
                e.preventDefault();

                let w = 60, h = 20;
                if (type === 'bumper') { w = 60; h = 20; }
                if (type === 'booster') { w = 40; h = 40; }

                this.ghostEntity = new Entity(type, 0, 0, w, h, 0);

                this.input.isDown = true;
                this.input.isDragging = true;

                this.ghostEntity.pos = this.input.getCanvasPos(e);
            }

            toggleRun() {
                if (this.state === 'SELECT') return;

                if (this.state === 'EDIT') {
                    this.state = 'PLAY';
                    this.ui.btnPlay.textContent = 'â–  åœæ­¢';
                    this.spawnBall();
                } else {
                    this.resetStage();
                }
            }

            spawnBall() {
                const start = this.physics.entities.find(e => e.type === 'start');
                if (start) {
                    const ball = new Ball(start.pos.x, start.pos.y);
                    this.physics.add(ball);
                }
            }

            resetStage() {
                if (this.state === 'SELECT') return;
                this.state = 'EDIT';
                this.ui.btnPlay.textContent = 'â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ';

                this.physics.entities = this.physics.entities.filter(e => e.type !== 'ball');

                const defs = this.stageData.entities.filter(e => e.type === 'gate');
                defs.forEach(def => {
                    const gameGate = this.physics.entities.find(e => e.type === 'gate' && e.pos.x === def.x && e.pos.y === def.y);
                    if (gameGate) gameGate.isActive = def.isActive;
                });
            }

            nextStage() {
                this.loadStage(this.currentStageIndex + 1);
            }

            retryStage() {
                this.resetStage();
                this.ui.modal.classList.add('hidden');
            }

            checkWinCondition() {
                const ball = this.physics.entities.find(e => e.type === 'ball');
                if (!ball) return;

                const goal = this.physics.entities.find(e => e.type === 'goal');
                if (goal) {
                    if (Math.abs(ball.pos.x - goal.pos.x) < goal.width / 2 &&
                        Math.abs(ball.pos.y - goal.pos.y) < goal.height / 2) {
                        this.gameClear();
                        return;
                    }
                }

                if (ball.pos.y > this.canvas.height + 50 ||
                    ball.pos.x < -50 || ball.pos.x > this.canvas.width + 50) {
                    this.gameOver("ãƒœãƒ¼ãƒ«ãŒè½ä¸‹ãƒ»æ¶ˆå¤±ã—ã¾ã—ãŸ");
                }
            }

            gameClear() {
                this.state = 'RESULT';
                this.ui.modalTitle.textContent = "ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼";
                this.ui.modalTitle.style.color = "var(--neon-lime)";
                this.ui.modalMsg.textContent = "ç´ æ™´ã‚‰ã—ã„é…ç½®ã§ã™ï¼";
                this.ui.modal.classList.remove('hidden');
                this.ui.btnNext.style.display = 'inline-block';
                this.ui.btnRetry.style.display = 'none';
            }

            gameOver(reason) {
                this.state = 'RESULT';
                this.ui.modalTitle.textContent = "å¤±æ•—...";
                this.ui.modalTitle.style.color = "var(--neon-magenta)";
                this.ui.modalMsg.textContent = reason;
                this.ui.modal.classList.remove('hidden');
                this.ui.btnNext.style.display = 'none';
                this.ui.btnRetry.style.display = 'inline-block';
            }

            handleEditInput() {
                // ã‚¯ãƒ©ãƒ³ãƒ—é–¢æ•°
                const clampToCanvas = (pos, margin = 20) => {
                    return new Vec2(
                        Math.max(margin, Math.min(this.canvas.width - margin, pos.x)),
                        Math.max(margin, Math.min(this.canvas.height - margin, pos.y))
                    );
                };

                // ã‚´ãƒ¼ã‚¹ãƒˆå‡¦ç†
                if (this.ghostEntity) {
                    this.ghostEntity.pos = clampToCanvas(this.input.pos);
                    // ãƒã‚¦ã‚¹ãŒé›¢ã•ã‚ŒãŸã‚‰é…ç½®
                    if (!this.input.isDown) {
                        // ä¸‹ç«¯ä»˜è¿‘ï¼ˆã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªï¼‰ã«ãƒ‰ãƒ­ãƒƒãƒ—ã—ãŸã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        if (this.input.pos.y > this.canvas.height - 50) {
                            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        } else {
                            this.ghostEntity.color = '#fff';
                            this.physics.add(this.ghostEntity);
                            this.placedEntities.push(this.ghostEntity);
                            this.inventory[this.ghostEntity.type]--;
                            this.updateInventoryUI();
                        }
                        this.ghostEntity = null;
                    }
                    return;
                }

                // æ—¢å­˜é…ç½®ç‰©ã®ãƒ‰ãƒ©ãƒƒã‚°
                if (this.input.isDown && !this.draggingEntity) {
                    for (let i = this.placedEntities.length - 1; i >= 0; i--) {
                        const e = this.placedEntities[i];
                        if (e.pos.dist(this.input.pos) < 30) {
                            this.draggingEntity = e;
                            break;
                        }
                    }
                    if (!this.draggingEntity && this.stageData.startZone) {
                        const start = this.physics.entities.find(e => e.type === 'start');
                        if (start && start.pos.dist(this.input.pos) < 30) {
                            this.draggingEntity = start;
                        }
                    }
                }

                if (this.draggingEntity) {
                    if (this.input.isDown) {
                        if (this.draggingEntity.type === 'start') {
                            // StartZone clamp
                            const sz = this.stageData.startZone;
                            const p = this.input.pos;
                            this.draggingEntity.pos = new Vec2(
                                Math.max(sz.x, Math.min(sz.x + sz.w, p.x)),
                                Math.max(sz.y, Math.min(sz.y + sz.h, p.y))
                            );
                        } else {
                            // é€šå¸¸: ã‚¯ãƒ©ãƒ³ãƒ—
                            this.draggingEntity.pos = clampToCanvas(this.input.pos);
                            // å‰Šé™¤ã‚¨ãƒªã‚¢åˆ¤å®šï¼ˆä¸‹ç«¯ï¼‰
                            if (this.input.pos.y > this.canvas.height - 50) {
                                this.draggingEntity._willDelete = true;
                            } else {
                                this.draggingEntity._willDelete = false;
                            }
                        }
                    } else {
                        // Drop
                        if (this.draggingEntity.type !== 'start') {
                            if (this.input.pos.y > this.canvas.height - 50) {
                                // å‰Šé™¤å®Ÿè¡Œ
                                this.placedEntities = this.placedEntities.filter(e => e !== this.draggingEntity);
                                this.physics.entities = this.physics.entities.filter(e => e !== this.draggingEntity);
                                if (this.inventory[this.draggingEntity.type] !== undefined) {
                                    this.inventory[this.draggingEntity.type]++;
                                    this.updateInventoryUI();
                                }
                            }
                        }
                        if (this.draggingEntity) this.draggingEntity._willDelete = false;
                        this.draggingEntity = null;
                    }
                }
            }

            loop(timestamp) {
                if (!this.lastTime) this.lastTime = timestamp;
                const dt = (timestamp - this.lastTime) / 1000;
                this.lastTime = timestamp;

                if (this.state === 'SELECT') {
                    // é¸æŠç”»é¢: ãƒ­ã‚¸ãƒƒã‚¯åœæ­¢
                } else if (this.state === 'EDIT') {
                    this.handleEditInput();
                } else if (this.state === 'PLAY') {
                    const steps = 4;
                    const subDt = Math.min(dt, 0.05) / steps;
                    for (let i = 0; i < steps; i++) {
                        this.physics.update(subDt);
                    }
                    this.checkWinCondition();
                }

                this.renderer.clear();

                if (this.state === 'SELECT') {
                    // èƒŒæ™¯ã®ã¿æç”»ãªã©ï¼ˆå¿…è¦ãªã‚‰ï¼‰
                    this.renderer.drawGrid();
                    requestAnimationFrame(t => this.loop(t));
                    return;
                }

                if (this.state === 'EDIT') {
                    this.renderer.drawGrid();
                    // Start Zone (Stage Data might be null if accessed during transition, check it)
                    if (this.stageData && this.stageData.startZone) {
                        const sz = this.stageData.startZone;
                        this.ctx.strokeStyle = 'rgba(0, 255, 0, 0.3)';
                        this.ctx.lineWidth = 2;
                        this.ctx.setLineDash([5, 5]);
                        this.ctx.strokeRect(sz.x, sz.y, sz.w, sz.h);
                        this.ctx.fillStyle = 'rgba(0, 255, 0, 0.1)';
                        this.ctx.fillRect(sz.x, sz.y, sz.w, sz.h);
                        this.ctx.setLineDash([]);
                    }
                    // Delete Zone Guide
                    if (this.ghostEntity || (this.draggingEntity && this.draggingEntity.type !== 'start')) {
                        // Footer height approx 80-100. Let's say 80px visual trigger
                        const triggerY = this.canvas.height - 50;
                        this.ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';
                        this.ctx.fillRect(0, triggerY, this.canvas.width, this.canvas.height - triggerY);
                        this.ctx.fillStyle = '#ff0000';
                        this.ctx.font = '16px Arial';
                        this.ctx.textAlign = 'center'; // Add align center
                        this.ctx.fillText('ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦å‰Šé™¤', this.canvas.width / 2, this.canvas.height - 15);
                        this.ctx.textAlign = 'left'; // Reset
                    }
                } else {
                    // PLAY Mode grid
                    this.renderer.drawGrid();
                }

                this.physics.entities.forEach(e => this.renderer.drawEntity(e));
                if (this.ghostEntity) {
                    this.ctx.globalAlpha = 0.5;
                    this.renderer.drawEntity(this.ghostEntity);
                    this.ctx.globalAlpha = 1.0;
                }

                requestAnimationFrame(t => this.loop(t));
            }
        }


        // ã‚²ãƒ¼ãƒ é–‹å§‹
        window.addEventListener('DOMContentLoaded', () => {
            const game = new GameManager();

            // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—ã§å›è»¢ã®å®Ÿè£… (ç°¡æ˜“)
            game.canvas.addEventListener('dblclick', (e) => {
                const pos = game.input.getCanvasPos(e);
                // ãƒ’ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
                for (let i = game.placedEntities.length - 1; i >= 0; i--) {
                    const ent = game.placedEntities[i];
                    if (ent.pos.dist(pos) < 30) {
                        ent.angle += Math.PI / 4; // 45åº¦
                        break;
                    }
                }
            });

            // ã‚¿ãƒƒãƒã§ã®ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—åˆ¤å®šã¯åˆ¥é€”å¿…è¦ã ãŒã€ä»Šå›ã¯PCãƒã‚¦ã‚¹ã®dblclickã®ã¿å¯¾å¿œã‹
            // ã‚¹ãƒãƒ›ç”¨ã«ã€Œã‚¿ãƒƒãƒ—ã—ã¦é›¢ã—ãŸç›´å¾Œãªã‚‰å›è»¢ã€ã‚’å…¥ã‚Œã‚‹
            let lastTapTime = 0;
            game.canvas.addEventListener('touchend', (e) => {
                if (game.state !== 'EDIT') return;
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTapTime;
                if (tapLength < 500 && tapLength > 0) {
                    // Double Tap
                    const pos = game.input.pos; // æœ€å¾Œã®ä½ç½®
                    for (let i = game.placedEntities.length - 1; i >= 0; i--) {
                        const ent = game.placedEntities[i];
                        if (ent.pos.dist(pos) < 40) {
                            ent.angle += Math.PI / 4;
                            e.preventDefault();
                            break;
                        }
                    }
                }
                lastTapTime = currentTime;
            });
        });
    </script>
</body>

</html>
```